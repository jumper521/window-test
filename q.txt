import tkinter as tk
from tkinter import messagebox, simpledialog, ttk
import boto3
import threading
import time

def get_mfa_credentials(mfa_serial_number, mfa_token):
    session = boto3.Session()
    sts_client = session.client('sts')
    response = sts_client.get_session_token(
        SerialNumber=mfa_serial_number,
        TokenCode=mfa_token
    )
    return response['Credentials']

def create_aws_client(service, aws_credentials):
    return boto3.client(
        service,
        aws_access_key_id=aws_credentials['AccessKeyId'],
        aws_secret_access_key=aws_credentials['SecretAccessKey'],
        aws_session_token=aws_credentials['SessionToken']
    )

def authenticate_with_mfa(mfa_serial_number):
    mfa_token = simpledialog.askstring("MFA Authentication", "Enter your MFA code:", parent=tk.Tk())
    if mfa_token:
        return get_mfa_credentials(mfa_serial_number, mfa_token)
    else:
        messagebox.showerror("Error", "MFA Authentication failed")
        exit()

# 以前の関数はそのまま残す
# ...

def create_app(mfa_serial_number):
    app = tk.Tk()
    app.withdraw()  # 一時的にルートウィンドウを隠す
    aws_credentials = authenticate_with_mfa(mfa_serial_number)
    client = create_aws_client('codepipeline', aws_credentials)
    app.deiconify()  # ルートウィンドウを再表示

    # 以前のcreate_app関数の内容をここに移動
    # ...

    return app

if __name__ == "__main__":
    mfa_serial_number = 'arn:aws:iam::123456789012:mfa/your-username'  # MFAデバイスのARNを設定
    pipelines = ["Pipeline1", "Pipeline2", "Pipeline3"]
    app = create_app(mfa_serial_number)
    app.mainloop()
