import boto3
import time

# ターゲットグループ名とリージョンを指定
target_group_name = 'YourTargetGroupName'
region = 'YourRegion'

# Boto3 クライアントを作成
elbv2_client = boto3.client('elbv2', region_name=region)

def check_target_health(target_group_arn):
    while True:
        # ターゲットグループのヘルスチェックを取得
        response = elbv2_client.describe_target_health(TargetGroupArn=target_group_arn)
        
        # ターゲットのヘルスステータスを確認
        target_health = response['TargetHealthDescriptions'][0]
        target_state = target_health['TargetHealth']['State']
        
        if target_state == 'healthy':
            print('Target is healthy.')
            break
        
        print(f'Target is {target_state}. Waiting for it to become healthy...')
        time.sleep(10)  # 10秒ごとに確認

def lambda_handler(event, context):
    # ターゲットグループの ARN を取得
    response = elbv2_client.describe_target_groups(Names=[target_group_name])
    target_group_arn = response['TargetGroups'][0]['TargetGroupArn']
    
    # ターゲットのヘルスチェックを監視
    check_target_health(target_group_arn)
    
    return {
        'statusCode': 200,
        'body': 'Lambda function executed successfully!'
    }
