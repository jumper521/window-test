import boto3

ec2_client = boto3.client('ec2')
codedeploy_client = boto3.client('codedeploy')

# 事前に定義した2つのインスタンスID
instance_id_1 = 'i-1234567890abcdef01'
instance_id_2 = 'i-0987654321fedcba0'

def get_codedeploy_instance_ids(deployment_group_name):
    response = codedeploy_client.get_deployment_group(
        applicationName='your-application-name',
        deploymentGroupName=deployment_group_name
    )
    return response['deploymentGroupInfo']['ec2TagFilters'][0]['Value']

def lambda_handler(event, context):
    # CodeDeployデプロイメントグループの名前を指定
    deployment_group_name = 'your-deployment-group-name'

    # CodeDeployデプロイメントグループに含まれるインスタンスのIDを取得
    instance_ids = get_codedeploy_instance_ids(deployment_group_name)

    if not instance_ids:
        return {
            'statusCode': 200,
            'body': 'インスタンスが見つかりません。'
        }

    # 事前に定義したインスタンスIDと比較して、異なる場合に停止
    for instance_id in instance_ids:
        if instance_id != instance_id_1 and instance_id != instance_id_2:
            ec2_client.stop_instances(InstanceIds=[instance_id])

    return {
        'statusCode': 200,
        'body': 'インスタンスの停止が完了しました。'
    }
